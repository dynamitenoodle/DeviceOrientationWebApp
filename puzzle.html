<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
    <title>Gleckner-Puzzle</title>
    <link rel="stylesheet" type="text/css" href="puzzleStyle.css">
    <!--
        The Canvas Guide
         https://www.w3schools.com/html/html5_canvas.asp
        The making a game in javascript guide
         https://msdn.microsoft.com/en-us/library/gg589497(v=vs.85).aspx 
        Creating more basic shapes
         https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Drawing_shapes
    -->
</head>

<body>
    <canvas id="myCanvas" width="500" height="500"></canvas>

    <!--<div class="ball"></div>-->
    
    <pre class="output"></pre>
</body>

<script>
    // window functions
    window.onload = function() { start(); };
    window.addEventListener("deviceorientation", handleOrientation, true);
    //window.addEventListener("keypress", handleInput, true);

    // the update loop interval
    setInterval(gameLoop, 1000 / 33);

    // attributes
    let c = document.getElementById("myCanvas");
    let ctx = c.getContext("2d");
    let back = new Image();

    // ball stuff
    // let ball   = document.querySelector('.ball');
    let radius = 10;
    let garden = document.querySelector('.garden');
    let output = document.querySelector('.output');

    let maxX = c.clientWidth  - radius;
    let maxY = c.clientHeight - radius;

    // movement stuff, the 1st number is x and the 2nd number is y
    let position = [240, 240];
    let velocity = [0, 0];
    let acceleration = [0, 0];
    let force = [0, 0];
    let maxSpeed = 5;

    // key presses
    let keysPressed = {};

    document.addEventListener("keydown", function(e) {
        keysPressed[e.keyCode] = true;
    });

    document.addEventListener("keyup", function(e) {
        keysPressed[e.keyCode] = false;
    });

    // what happens at the start of the game
    function start(){
        drawGameBoard();
        drawBall(position);
    }
    
    // drawing the game board
    function drawGameBoard(){
        // background
        ctx.fillStyle = "black";
        
        ctx.fillRect(0, 0, 500, 500);
        ctx.clearRect(15, 15, 470, 470);
        back = ctx.getImageData(0, 0, 30, 30);

        /*  ctx.moveTo(0,0); ctx.lineTo(0,500);  ctx.stroke();  */
    }

    function gameLoop() {
        // Do stuff.
        position = movement(position);
        acceleration = [0, 0];
        drawGameBoard();
        drawBall(position);
    }

    // drawing the ball
    function drawBall(pos){
        ctx.beginPath();
        ctx.arc(pos[0], pos[1], radius, 0, 2 * Math.PI, false);
        ctx.fillStyle = 'purple';
        ctx.fill();
        ctx.lineWidth = 5;
        ctx.strokeStyle = '#003300';
        ctx.stroke;
    }

    function handleOrientation(event) {
      let x = event.beta;  // In degree in the range [-180,180]
      let y = event.gamma; // In degree in the range [-90,90]

      //output.innerHTML  = "beta / X : " + x + "\n";
      //output.innerHTML += "gamma / Y: " + y + "\n";

      // Because we don't want to have the device upside down
      // We constrain the x value to the range [-90,90]
      if (x >  90) { x =  90};
      if (x < -90) { x = -90};

      // To make computation easier we shift the range of 
      // x and y to [0,180]
      x += 90;
      y += 90;

      // 10 is half the size of the ball
      // It center the positioning point to the center of the ball
      // ball.style.top  = (maxX*x/180 - 10) + "px";
      // ball.style.left = (maxY*y/180 - 10) + "px";
    }

    function movement(pos){
        // testing basic movement
        let direction = 10;
        let x = 0;
        let y = 0;

        // w:119  a:97  d:100  s:115
        if (keysPressed["65"]){
            // output.innerHTML += "a";
            x -= direction;
        }
        if (keysPressed["68"]){
            // output.innerHTML += "d";
            x += direction;
        }
        if (keysPressed["83"]){
            // output.innerHTML += "s";
            y += direction;
        }
        if (keysPressed["87"]){
            // output.innerHTML += "w";
            y -= direction;
        }

        // bail out early is theres no movement
        if ((x == 0 && y == 0) && (velocity[0] == 0 && velocity[1] == 0))
            return pos;

        else if (x == 0 && y == 0){
            velocity[0] = velocity[0] * .9;
            velocity[1] = velocity[1] * .9;
            pos = updatePosition(pos);
            return pos;
        }

        let seekForce = [0, 0];
        seekForce = seek(pos, x, y); 
        applyForce(seekForce);
        pos = updatePosition(pos);
        return pos;
    }

    // calculating the direction you want the ball to go
    function seek(pos, x, y){        
        let wantedPos = [0, 0];

        wantedPos[0] = (pos[0] + x) - pos[0];
        wantedPos[1] = (pos[1] + y) - pos[1];

        //normalize
        wantedPos = normalize(wantedPos);

        wantedPos = [wantedPos[0] * maxSpeed, wantedPos[1] * maxSpeed];
        let steer = [wantedPos[0] - velocity[0], wantedPos[1] - velocity[1]];

        if (steer[0] + steer[1] > maxSpeed){
            steer = normalize(steer);
            steer = [steer[0] * maxSpeed, steer[1] * maxSpeed];
        }

        return steer;
    }

    // the force snuff
    function applyForce(newForce){
        // output.innerHTML = "Force: " + force + "\n";
        acceleration[0] += newForce[0] * (1 / 33);
        acceleration[1] += newForce[1] * (1 / 33);
    }

    // normalizing
    function normalize(vector){
        let magnitude = Math.sqrt(vector[0] * vector[0] + vector[1] * vector[1]);
        vector = [vector[0] / magnitude, vector[1] / magnitude];
        return vector;
    }

    // the force snuff
    function updatePosition(pos){
        // output.innerHTML += "Acceleration: " + acceleration + "\n";
        velocity[0] += acceleration[0];
        velocity[1] += acceleration[1];
        // output.innerHTML += "Velocity: " + velocity + "\n";
        //console.dir("Velocity:" + velocity);
        pos[0] += velocity[0];
        pos[1] += velocity[1];

        // set the movement
        // ball.style.left = pos[0] + "px";
        // ball.style.top = pos[1] + "px";

        return pos;
    }

/*
    function handleInput(event) {
        let key = event.keyCode || event.which;
        let speed = 1;

        let x = ballLeft;
        let y = ballTop;

        console.log(`X: ${x} y: ${y}\nKey: ${key}`);

        // w:119  a:97  d:100  s:115
        if (key == 97){
            // output.innerHTML += "a";
            x -= speed;
        }

        if (key == 100){
            // output.innerHTML += "d";
            x += speed;
        }

        if (key == 115){
            // output.innerHTML += "s";
            y += speed;
        }

        if (key == 119){
            // output.innerHTML += "w";
            y -= speed;
        }

        ballLeft = x;
        ballTop = y;
    }
*/
</script>

</html>